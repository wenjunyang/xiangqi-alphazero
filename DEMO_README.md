# 中国象棋 AlphaZero AI 演示界面

基于 Streamlit 构建的交互式演示界面，可与训练好的象棋 AI 对弈。

## 功能特性

1. **模型选择**：自动发现 `models/` 目录下的所有 `.pt` 模型文件，支持切换不同模型
2. **AI 执棋选择**：可选择 AI 执红方（先手）或黑方（后手）
3. **棋盘展示**：清晰展示当前棋局状态
4. **模型输出可视化**：
   - 局面评分（Value Score）：范围 [-1, 1]，正值表示当前玩家优势
   - Top 15 走法及概率：展示模型认为最优的走法及其置信度
   - 标注 AI 实际选择的走法（✅）
   - 标注非法走法（❌）

## 安装依赖

```bash
pip install streamlit torch numpy
```

## 启动界面

```bash
cd xiangqi-ai
streamlit run demo_app.py
```

浏览器会自动打开 `http://localhost:8501`

## 使用说明

### 1. 配置

在左侧边栏：
- **选择模型**：从下拉菜单中选择要使用的模型
- **AI 执棋**：选择 AI 执红方或黑方
- **重新开始**：点击按钮重置棋局
- **AI 走棋**：手动触发 AI 走棋（通常会自动触发）

### 2. 走棋

在棋盘下方的输入框中：
1. 输入起点坐标（行、列）
2. 输入终点坐标（行、列）
3. 点击"执行走法"按钮

**坐标说明**：
- 行：0-9（从上到下）
- 列：0-8（从左到右）

例如：移动红方中炮（位置 9,4）到中线（位置 4,4）
- 起点行：9
- 起点列：4
- 终点行：4
- 终点列：4

### 3. 查看模型输出

右侧面板实时展示：
- **局面评分**：AI 对当前局面的评估
- **Top 走法**：AI 考虑的最优走法及概率
  - ✅ 表示 AI 实际选择的走法
  - ⭕ 表示合法但未选择的走法
  - ❌ 表示非法走法（模型输出但不符合规则）

## 模型文件

模型文件应放置在 `models/` 目录下，支持两种格式：

1. **完整检查点**（训练过程中保存）：
   ```python
   {
       'model_state_dict': ...,
       'config': {'num_channels': 128, 'num_res_blocks': 6},
       'iteration': 10,
       ...
   }
   ```

2. **纯模型权重**（仅包含 state_dict）：
   ```python
   {
       'model_state_dict': ...,
       'config': {...}
   }
   ```

## 技术细节

- **MCTS 模拟次数**：100（可在代码中调整）
- **温度参数**：0.1（接近确定性选择）
- **设备**：CPU（可修改为 CUDA 加速）

## 故障排除

### 问题：未找到模型文件

**解决**：确保 `models/` 目录存在且包含 `.pt` 文件

```bash
ls models/*.pt
```

### 问题：模型加载失败

**解决**：检查模型文件格式是否正确，确保包含 `model_state_dict` 或直接是 state_dict

### 问题：走法非法

**解决**：
1. 检查坐标是否在有效范围内（行 0-9，列 0-8）
2. 确认起点有己方棋子
3. 确认终点符合该棋子的移动规则

## 开发

修改界面后，Streamlit 会自动检测文件变化并提示重新加载。

**关键文件**：
- `demo_app.py`：主程序
- `training/game.py`：游戏逻辑
- `training/model.py`：神经网络模型
- `training/mcts.py`：蒙特卡洛树搜索

## 示例对局

1. 启动应用，选择 `best_model.pt`
2. 选择 AI 执黑方（后手）
3. 作为红方走第一步：炮二平五（起点 9,1 → 终点 9,4）
4. AI 自动走黑方第一步
5. 观察右侧模型输出，查看 AI 的思考过程

## 性能优化

如果有 GPU，可修改代码以加速推理：

```python
# 在 main() 函数中
model, config = load_model(selected_model_path, device='cuda')
st.session_state.mcts = MCTS(
    model, 
    num_simulations=200,  # 增加模拟次数
    c_puct=1.5,
    device='cuda'  # 使用 GPU
)
```

## 许可

本项目采用 MIT 许可证。
